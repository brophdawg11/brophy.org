<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="lang">
  <head data-n-head="">
    <title data-n-head="true">Matt Brophy's Personal Website</title><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="true" data-hid="description" name="description" content="Matt Brophy's Personal Website"><meta data-n-head="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-n-head="true" name="apple-mobile-web-app-capable" content="yes"><meta data-n-head="true" name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta data-n-head="true" name="apple-mobile-web-app-title" content="brophy.org"><meta data-n-head="true" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="true" data-hid="author" name="author" content="Matt Brophy"><meta data-n-head="true" data-hid="theme-color" name="theme-color" content="black"><meta data-n-head="true" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="true" data-hid="og:title" name="og:title" property="og:title" content="brophy.org"><meta data-n-head="true" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="brophy.org"><meta data-n-head="true" data-hid="og:description" name="og:description" property="og:description" content="Matt Brophy's Personal Website"><link data-n-head="true" rel="manifest" href="/manifest.json"><link data-n-head="true" rel="icon" type="image/x-icon" href="/favicon/favicon.ico"><link data-n-head="true" rel="shortcut icon" type="image/x-icon" href="/favicon/favicon.ico"><link data-n-head="true" rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"><link data-n-head="true" rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="57x57" href="/favicon/apple-touch-icon-57x57.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="60x60" href="/favicon/apple-touch-icon-60x60.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="72x72" href="/favicon/apple-touch-icon-72x72.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="76x76" href="/favicon/apple-touch-icon-76x76.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="114x114" href="/favicon/apple-touch-icon-114x114.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="120x120" href="/favicon/apple-touch-icon-120x120.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="144x144" href="/favicon/apple-touch-icon-144x144.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="152x152" href="/favicon/apple-touch-icon-152x152.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="167x167" href="/favicon/apple-touch-icon-167x167.png"><link data-n-head="true" rel="apple-touch-icon" type="image/x-icon" sizes="180x180" href="/favicon/apple-touch-icon-180x180.png"><link data-n-head="true" rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png"><link rel="preload" href="/_nuxt/runtime.94c5cfbdd2fb87a1541a.js" as="script"><link rel="preload" href="/_nuxt/async/commons.app.9c5135f89d753b8191ab.js" as="script"><link rel="preload" href="/_nuxt/async/app.000c4097745af34ba54f.js" as="script"><link rel="preload" href="/_nuxt/async/pages/post/_slug.696eef9b23c1afe6e9f3.js" as="script"><style data-vue-ssr-id="8b5acbe2:0 452097a8:0 17cfdfa9:0 132df51d:0 95822e54:0 4effc658:0 745b4ac0:0 27df31d4:0 58764380:0">@font-face{font-family:icon-font;font-display:fallback;src:url(/_nuxt/fonts/02c7d2c.woff) format("woff");font-weight:400;font-style:normal}[class*=" fa-"]:before,[class^=fa-]:before{font-family:icon-font;font-style:normal;font-weight:400;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fa-home:before{content:"\e800"}.fa-chat:before{content:"\e801"}.fa-left-big:before{content:"\e802"}.fa-right-big:before{content:"\e803"}.fa-twitter:before{content:"\f099"}.fa-facebook:before{content:"\f09a"}.fa-github-circled:before{content:"\f09b"}.fa-gplus:before{content:"\f0d5"}.fa-angle-double-right:before{content:"\f101"}.fa-rss-squared:before{content:"\f143"}.fa-doc-text-inv:before{content:"\f15c"}.fa-instagram:before{content:"\f16d"}a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}table{border-collapse:collapse;border-spacing:0}@font-face{font-family:system;font-style:normal;font-weight:300;src:local(".SFNSText-Light"),local(".HelveticaNeueDeskInterface-Light"),local(".LucidaGrandeUI"),local("Ubuntu Light"),local("Segoe UI Light"),local("Roboto-Light"),local("DroidSans"),local("Tahoma")}body{font-family:system}*{box-sizing:border-box}body{font-size:100%;color:#181818}body,h1{font-family:"PT Serif",serif}h1{font-size:1.5rem;font-weight:700;margin:.67rem 0}@media (min-width:768px){h1{font-size:2rem}}h2{font-family:"PT Serif",serif;font-size:1.25rem;font-weight:700;margin:.75rem 0}@media (min-width:768px){h2{font-size:1.6rem}}h3{font-family:"PT Serif",serif;font-size:1rem;font-weight:700;margin:.83rem 0}@media (min-width:768px){h3{font-size:1.4rem}}h4{font-family:"PT Serif",serif;font-size:.83rem;font-weight:700;margin:1rem 0}@media (min-width:768px){h4{font-size:1.2rem}}pre{font-family:monospace;overflow-y:hidden;overflow-x:auto}a{color:#aa5d00;text-decoration:none;cursor:pointer}a:hover{text-decoration:underline}.nuxt-progress{background-color:#fff;height:5px}@media (min-width:1024px){.nuxt-progress{left:384px;background-color:#aa5d00}}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.page-aside{background-position:50% 50%;background-size:cover;height:150px;background-image:url(/_nuxt/img/f09bc75.jpg)}@media screen and (min-width:768px){.page-aside{background-image:url(/_nuxt/img/d5754ab.jpg)}}@media screen and (min-width:1024px){.page-aside{position:fixed;top:0;left:0;bottom:0;width:384px;height:100%;background-image:url(/_nuxt/img/7cb7e48.jpg)}}.page-content-wrapper{display:flex;flex-direction:column;position:relative;padding:2em}@media screen and (min-width:1024px){.page-content-wrapper{padding:2em 0;margin-left:calc(384px + 2em);width:calc(100% - 384px - 4em);min-height:100vh}}.page-content{width:100%;max-width:768px;margin:auto;padding-bottom:2em;flex:1;display:flex;flex-direction:column;justify-content:center}.page-header{position:absolute;top:-75px;left:0;right:0;padding-bottom:2em;text-align:center}@media screen and (min-width:1024px){.page-header{position:relative;top:0}}.page-footer{padding-top:2em;text-align:center}.page-footer-nav{text-align:center;font-size:.75em}.s-footer-links.page-links__ul{padding-bottom:2em}.s-footer-links .page-link__li{margin:1.5em .75em}@media screen and (min-width:500px){.s-footer-links .page-link__li{margin:1em}}.page-links__ul{text-align:center;color:#aa5d00}.page-link__li{display:inline-block;margin:1em}@media screen and (min-width:1024px){.page-link__li{position:relative}}.page-link__a{background-color:#fafafa;border:2px solid #aa5d00;border-radius:50%;transition:all .2s;padding:1.25em .7em 1em;text-decoration:none;font-family:system,sans-serif}.page-link__a .fa{font-size:1.5em}.page-link__a:active,.page-link__a:hover,.page-link__a:link,.page-link__a:visited{color:inherit;text-decoration:none}.page-link__a:focus,.page-link__a:hover{background-color:#aa5d00;color:#fafafa}@media screen and (min-width:1024px){.page-link__a:focus .page-link__p,.page-link__a:hover .page-link__p{opacity:1}}.page-link__p{display:none}@media screen and (min-width:1024px){.page-link__p{display:block;color:#aa5d00;opacity:0;position:absolute;bottom:0;width:150%;margin-bottom:-3em;margin-left:-25%;text-align:center;left:0;right:0;transition:opacity .2s;font-size:.8em}}.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}.c-post__title{margin-bottom:10px}.c-post__meta{font-size:.9em;font-style:italic;margin-bottom:2em}.c-post__date{font-style:italics}.c-post__content{font-size:1.15em;line-height:1.75em}.c-post__content p{font-size:.9em;line-height:1.5em;padding-bottom:2em}@media screen and (min-width:768px){.c-post__content p{font-size:1em}}.c-post__content p img{display:block;margin:0 auto;max-width:100%}.c-post__content li{font-size:.9em;line-height:1.5em}.c-post__content strong{font-weight:700}.c-post__content em{font-style:italic}.c-post__content code{padding:0 3px;font-family:monospace;background-color:#eee}.c-post__content pre{padding-bottom:2em;margin:0}@media screen and (min-width:768px){.c-post__content pre{margin-left:2em;margin-right:2em}}.c-post__content pre code{padding:1em;font-size:.9em;line-height:1.25em}.c-post__content blockquote{padding:1em;background-color:#eee;margin:0 0 2em;font-style:italic}@media screen and (min-width:768px){.c-post__content blockquote{margin-left:2em;margin-right:2em}}.c-post__content blockquote ol,.c-post__content blockquote ul{margin-left:40px;padding-bottom:2em}.c-post__content blockquote p:last-child{padding-bottom:0}.c-post__content ol,.c-post__content ul{margin-left:40px;margin-bottom:2em}.c-post__share{text-align:right;margin-bottom:2em}.c-post__share-lead-in{padding-bottom:.66667em}.c-post__share-medium .fa{padding:5px;border-radius:50%;transition:color .2s,background-color .2s}.c-post__share-medium .fa:focus,.c-post__share-medium .fa:hover{color:#fff;background-color:#aa5d00}.c-meta__line1{padding-bottom:.5rem}.c-meta__divider{padding:0 10px}.c-post-nav{display:flex}.c-post-nav__link{flex-grow:1}.c-post-nav__link--previous{padding-right:10px;text-align:left}.c-post-nav__link--next{padding-left:10px;text-align:right}.page-footer-line{line-height:1.5em;padding:.25em}</style>
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><aside class="page-aside"><div class="page-aside-img-loader"></div></aside> <section class="page-content-wrapper"><header class="page-header"><nav><ul class="page-links__ul s-header-links"><li class="page-link__li"><a href="/" title="Home" class="page-link__a nuxt-link-active"><span class="fa fa-home"></span><span class="page-link__p">Home</span></a></li><li class="page-link__li"><a href="/posts/" title="Blog" class="page-link__a"><span class="fa fa-chat"></span><span class="page-link__p">Blog</span></a></li><li class="page-link__li"><a href="/resume/" title="Resume" class="page-link__a"><span class="fa fa-doc-text-inv"></span><span class="page-link__p">Resume</span></a></li></ul></nav></header> <div class="page-content"><article><header><h1 class="c-post__title">
            Beware of hidden inputs in Angular filters
        </h1> <div class="c-post__meta"><div><p class="c-meta__line1"><span title="Jan 14, 2017" class="c-meta__date">
            3 years ago
        </span> <span class="c-meta__divider c-meta__divider--first">|</span> <span class="c-meta__readtime">5 min read</span></p> <p class="c-meta__line2"><span class="c-meta__tags">
            Tags:
            <a href="/tag/angularjs/" title="angularjs">angularjs</a>, <a href="/tag/javascript/" title="javascript">javascript</a>, <a href="/tag/functional/" title="functional">functional</a><!----></span></p></div></div></header> <section class="c-post__content"><p>If you've been writing JavaScript (or really any language for that matter) in the past few years, chances are you've caught wind of the rising popularity of functional programming paradigms.  <em>Pure functions</em> are one of the major concepts of functional programming, and as it turns out, the usage of impure functions in Angular filters can produce some not-so-obvious bugs in your AngularJS application.</p>
<p>Don't worry, I'm not going to get into a big discussion of the advantages of functional programing/pure functions/immutability in this post.  There's plenty of stuff out there from people far smarter than me that you can find with a few simple Google searches.  However, this Angular filter nuance almost bit me recently, and the subtle nature of it caught me by surprise - even though it seems pretty blatantly obvious after the fact.  </p>
<p><strong>TL;DR;</strong> Here's a quick <a href="https://plnkr.co/edit/WMMNWiSqE0Uij9ZXwy4G?p=preview" title="Broken Filter Example">Plnkr</a> demonstrating a broken and fixed filter using impure/pure functions in Angular.</p>
<h3 id="pure-functions">Pure Functions</h3>
<p>For some quick reading on pure functions, I would recommend reading Kris Jenkins' great <a href="http://blog.jenkster.com/2015/12/what-is-functional-programming.html" title="What is Functional Programming">What is Functional Programming</a> article or checking out the Wikipedia page for <a href="https://en.wikipedia.org/wiki/Pure_function" title="Pure Function">Pure Functions</a>.  In short, a pure function should have explicit inputs, zero side-effects, and always produce the same output for a set of inputs.</p>
<pre><code class="hljs javascript"><span class="hljs-comment">// Bad: Impure function - hidden input from SalesService</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTaxBad</span>(<span class="hljs-params">price</span>) </span>{
    <span class="hljs-keyword">return</span> price * SalesService.getTaxRate());
}

<span class="hljs-comment">// Good: Pure function - no hidden inputs</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTaxGood</span>(<span class="hljs-params">price, taxRate</span>) </span>{
    <span class="hljs-keyword">return</span> price * taxRate;
}</code></pre>
<p>In the second example, we've removed the hidden <code>SalesService.getTaxRate()</code> input and made it an explicit input to the function.</p>
<h3 id="angular-filters">Angular Filters</h3>
<p><a href="https://code.angularjs.org/1.4.14/docs/guide/filter" title="Angular Filters">Angular filters</a> are a handy little mechanism for transforming data within Angular templates.</p>
<pre><code class="hljs javascript">angular.module(<span class="hljs-string">'app'</span>).filter(<span class="hljs-string">'uppercase'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">input</span>) </span>{
    <span class="hljs-keyword">return</span> (input || <span class="hljs-string">''</span>).toUpperCase();
  };
})</code></pre>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>></span>{{ 'hello world' | uppercase }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>></span>

<span class="hljs-comment">&lt;!-- produces --></span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>></span>HELLO WORLD<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>></span></code></pre>
<p>Cool - super simple, super useful.</p>
<h3 id="impure-functions-as-angular-filters">Impure functions as Angular filters</h3>
<p>So what's the problem?  It comes down to to the logic used in the dirty checking in Angular's digest cycles.  Let's pretend we wanted to use our <code>calculateTaxBad</code> method above as a filter to produce an itemized pricing display:</p>
<pre><code class="hljs javascript">angular.module(<span class="hljs-string">'app'</span>).filter(<span class="hljs-string">'taxBroken'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">SalesService</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">price</span>) </span>{
        <span class="hljs-keyword">return</span> price * SalesService.getTaxRate();
    }    
});</code></pre>
<p>We could then generate the display:</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>></span>Price: {{ item.price | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>></span>Tax: {{ item.price | taxBroken | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>></span></code></pre>
<p>This is where the "magical" nature of Angular's digest cycle almost came back to bite me.  At first glance, it seems reasonable to think that when the digest cycle runs, it'll evaluate the <em>entire</em> expression <code>{{ item.price | taxBroken | currency }}</code> and determine if a re-render is required.  </p>
<p>However, if we look deep into the internals of Angular's parser and dirty checking logic, we can see where the problem arises:</p>
<p><a href="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-impure.png"><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-impure.png" alt="Filter with hidden input"></a></p>
<p>When parsing the expression, Angular determines that there is only one input for the expression, <code>data.price</code>.  This is based on an internal Angular assumption that the filter is pure, and therefore given one input, it will always produce the same output.  Thus, Angular doesn't need to bother executing the <code>taxBroken</code> or <code>currency</code> filters if <code>data.price</code> hasn't changed, because by definition, the output will not change.  And boom - the nasty hidden input gets ignored and our UI is broken if the <code>SalesService.taxRate</code> value changes without the corresponding price changing.</p>
<h3 id="pure-functions-as-angular-filters">Pure functions as Angular filters</h3>
<p>the fix is fairly straightforward now that we know what the problem is.  By removing the hidden input, we can adjust our filter:</p>
<pre><code class="hljs javascript">angular.module(<span class="hljs-string">'app'</span>).filter(<span class="hljs-string">'taxFixed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">SalesService</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">price, taxRate</span>) </span>{
        <span class="hljs-keyword">return</span> price * taxRate;
    }    
});</code></pre>
<p>We could then generate the display by explicitly passing the taxRate as a second input to the filter:</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>></span>Price: {{ item.price | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>></span>Tax: {{ item.price | taxFixed:getTaxRate() | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>></span></code></pre>
<p>Now, let's look again at the Angular internals:</p>
<p><a href="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-pure.png"><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-pure.png" alt="Filter with hidden input"></a></p>
<p>We can see by adjusting the filter to pass the <code>taxRate</code> in as an input to the filter, the expression is now parsed with 2 inputs, the same first input as before, and an additional second input which is a function call corresponding to <code>getTaxRate()</code>.  </p>
<p>This produces our Plnkr UI showing the live usages of the broken and fixed versions of the filter while updating the tax rate:</p>
<p><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/output.png" alt="Plnkr UI"></p>
<h3 id="takeaway">Takeaway</h3>
<p>In Angular's defense, they are actually quite <a href="https://code.angularjs.org/1.4.14/docs/guide/filter#creating-custom-filters" title="Angular Custom Filters">explicit</a> about this in their documentation, but it's buried a bit down in the <code>$filter</code> documentation.  And, to be honest, I would venture to guess that most beginners learning how to implement filters are not reading the full Angular docs, but rather reading from a simplified blog post or Stack Overflow response that may not touch on the pure function requirement</p>
<blockquote>
<p> The filter function should be a <a href="https://en.wikipedia.org/wiki/Pure_function" title="Pure Function">pure function</a>, which means that it should be stateless and idempotent. Angular relies on these properties and executes the filter only when the inputs to the function change.</p>
</blockquote>
<p>That's it for today.  Hopefully this helps someone, somewhere, trying to track down a filter bug in their app.</p>
</section> <footer><div class="c-post__share"><p class="c-post__share-lead-in">
                Enjoy this post?
            </p> <a href="https://twitter.com/share?text=Beware of hidden inputs in Angular filters&amp;amp;url=https://brophy.org/post/beware-hidden-inputs-in-angular-filters" class="c-post__share-medium">
                Share on Twitter
            </a>

            or

            <a href="https://twitter.com/search?q=https://brophy.org/post/beware-hidden-inputs-in-angular-filters" target="_blank" rel="noopener noreferrer" class="c-post__share-medium">
                Discuss on Twitter
            </a></div> <div class="c-post-nav"><!----> <!----></div></footer></article></div> <footer class="page-footer"><nav class="page-footer-nav"><ul class="page-links__ul s-footer-links"><li class="page-link__li"><a href="https://www.github.com/brophdawg11" title="GitHub" target="_blank" rel="noopener" class="page-link__a"><span class="fa fa-github-circled"></span><span class="page-link__p">GitHub</span></a></li><li class="page-link__li"><a href="https://www.instagram.com/brophdawg11" title="Instagram" target="_blank" rel="noopener" class="page-link__a"><span class="fa fa-instagram"></span><span class="page-link__p">Instagram</span></a></li><li class="page-link__li"><a href="https://www.twitter.com/brophdawg11" title="Twitter" target="_blank" rel="noopener" class="page-link__a"><span class="fa fa-twitter"></span><span class="page-link__p">Twitter</span></a></li></ul></nav> <div><p class="page-footer-line">
        built with
        <a href="https://vuejs.org/" title="Vue" target="_blank" rel="noopener">
            vue
        </a>
        and
        <a href="https://nuxtjs.org/" title="Nuxt" target="_blank" rel="noopener">
            nuxt
        </a></p> <p class="page-footer-line">
        stored/hosted in
        <a href="https://www.github.com/brophdawg11/brophy.org" title="GitHub" target="_blank" rel="noopener">
            github
        </a>
        using
        <a href="https://pages.github.com/" title="Github Pages" target="_blank" rel="noopener">
            github pages
        </a></p> <p class="page-footer-line">
        side images from
        <a href="https://www.gratisography.com/" title="Gratisography" target="_blank" rel="noopener">
            gratisography
        </a></p> <p class="page-footer-line">
        icons from
        <a href="https://fontawesome.com/" title="Font-Awesome" target="_blank" rel="noopener">
            font-awesome
        </a>
        via
        <a href="http://fontello.com/" title="Fontello" target="_blank" rel="noopener">
            fontello
        </a></p> <p class="page-footer-line">
        Â© Copyright 2019 Matt Brophy
    </p></div></footer></section></div></div></div><script>window.__NUXT__=function(e,s){return{layout:"default",data:[[e,e]],error:null,state:{url:"https://brophy.org",title:s,description:"Matt Brophy's Website",rss:{title:"Matt Brophy's Blog"},pageSize:6,post:{title:"Beware of hidden inputs in Angular filters",author:s,postDate:"2017-01-14 12:00",tags:"angularjs,javascript,functional",__content:'<p>If you&#39;ve been writing JavaScript (or really any language for that matter) in the past few years, chances are you&#39;ve caught wind of the rising popularity of functional programming paradigms.  <em>Pure functions</em> are one of the major concepts of functional programming, and as it turns out, the usage of impure functions in Angular filters can produce some not-so-obvious bugs in your AngularJS application.</p>\n<p>Don&#39;t worry, I&#39;m not going to get into a big discussion of the advantages of functional programing/pure functions/immutability in this post.  There&#39;s plenty of stuff out there from people far smarter than me that you can find with a few simple Google searches.  However, this Angular filter nuance almost bit me recently, and the subtle nature of it caught me by surprise - even though it seems pretty blatantly obvious after the fact.  </p>\n<p><strong>TL;DR;</strong> Here&#39;s a quick <a href="https://plnkr.co/edit/WMMNWiSqE0Uij9ZXwy4G?p=preview" title="Broken Filter Example">Plnkr</a> demonstrating a broken and fixed filter using impure/pure functions in Angular.</p>\n<h3 id="pure-functions">Pure Functions</h3>\n<p>For some quick reading on pure functions, I would recommend reading Kris Jenkins&#39; great <a href="http://blog.jenkster.com/2015/12/what-is-functional-programming.html" title="What is Functional Programming">What is Functional Programming</a> article or checking out the Wikipedia page for <a href="https://en.wikipedia.org/wiki/Pure_function" title="Pure Function">Pure Functions</a>.  In short, a pure function should have explicit inputs, zero side-effects, and always produce the same output for a set of inputs.</p>\n<pre><code class="hljs javascript"><span class="hljs-comment">// Bad: Impure function - hidden input from SalesService</span>\n<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTaxBad</span>(<span class="hljs-params">price</span>) </span>{\n    <span class="hljs-keyword">return</span> price * SalesService.getTaxRate());\n}\n\n<span class="hljs-comment">// Good: Pure function - no hidden inputs</span>\n<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTaxGood</span>(<span class="hljs-params">price, taxRate</span>) </span>{\n    <span class="hljs-keyword">return</span> price * taxRate;\n}</code></pre>\n<p>In the second example, we&#39;ve removed the hidden <code>SalesService.getTaxRate()</code> input and made it an explicit input to the function.</p>\n<h3 id="angular-filters">Angular Filters</h3>\n<p><a href="https://code.angularjs.org/1.4.14/docs/guide/filter" title="Angular Filters">Angular filters</a> are a handy little mechanism for transforming data within Angular templates.</p>\n<pre><code class="hljs javascript">angular.module(<span class="hljs-string">\'app\'</span>).filter(<span class="hljs-string">\'uppercase\'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{\n  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">input</span>) </span>{\n    <span class="hljs-keyword">return</span> (input || <span class="hljs-string">\'\'</span>).toUpperCase();\n  };\n})</code></pre>\n<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ \'hello world\' | uppercase }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>\n\n<span class="hljs-comment">&lt;!-- produces --&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>HELLO WORLD<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></code></pre>\n<p>Cool - super simple, super useful.</p>\n<h3 id="impure-functions-as-angular-filters">Impure functions as Angular filters</h3>\n<p>So what&#39;s the problem?  It comes down to to the logic used in the dirty checking in Angular&#39;s digest cycles.  Let&#39;s pretend we wanted to use our <code>calculateTaxBad</code> method above as a filter to produce an itemized pricing display:</p>\n<pre><code class="hljs javascript">angular.module(<span class="hljs-string">\'app\'</span>).filter(<span class="hljs-string">\'taxBroken\'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">SalesService</span>) </span>{\n    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">price</span>) </span>{\n        <span class="hljs-keyword">return</span> price * SalesService.getTaxRate();\n    }    \n});</code></pre>\n<p>We could then generate the display:</p>\n<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Price: {{ item.price | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Tax: {{ item.price | taxBroken | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></code></pre>\n<p>This is where the &quot;magical&quot; nature of Angular&#39;s digest cycle almost came back to bite me.  At first glance, it seems reasonable to think that when the digest cycle runs, it&#39;ll evaluate the <em>entire</em> expression <code>{{ item.price | taxBroken | currency }}</code> and determine if a re-render is required.  </p>\n<p>However, if we look deep into the internals of Angular&#39;s parser and dirty checking logic, we can see where the problem arises:</p>\n<p><a href="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-impure.png"><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-impure.png" alt="Filter with hidden input"></a></p>\n<p>When parsing the expression, Angular determines that there is only one input for the expression, <code>data.price</code>.  This is based on an internal Angular assumption that the filter is pure, and therefore given one input, it will always produce the same output.  Thus, Angular doesn&#39;t need to bother executing the <code>taxBroken</code> or <code>currency</code> filters if <code>data.price</code> hasn&#39;t changed, because by definition, the output will not change.  And boom - the nasty hidden input gets ignored and our UI is broken if the <code>SalesService.taxRate</code> value changes without the corresponding price changing.</p>\n<h3 id="pure-functions-as-angular-filters">Pure functions as Angular filters</h3>\n<p>the fix is fairly straightforward now that we know what the problem is.  By removing the hidden input, we can adjust our filter:</p>\n<pre><code class="hljs javascript">angular.module(<span class="hljs-string">\'app\'</span>).filter(<span class="hljs-string">\'taxFixed\'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">SalesService</span>) </span>{\n    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">price, taxRate</span>) </span>{\n        <span class="hljs-keyword">return</span> price * taxRate;\n    }    \n});</code></pre>\n<p>We could then generate the display by explicitly passing the taxRate as a second input to the filter:</p>\n<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Price: {{ item.price | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Tax: {{ item.price | taxFixed:getTaxRate() | currency }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></code></pre>\n<p>Now, let&#39;s look again at the Angular internals:</p>\n<p><a href="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-pure.png"><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/parser-filter-pure.png" alt="Filter with hidden input"></a></p>\n<p>We can see by adjusting the filter to pass the <code>taxRate</code> in as an input to the filter, the expression is now parsed with 2 inputs, the same first input as before, and an additional second input which is a function call corresponding to <code>getTaxRate()</code>.  </p>\n<p>This produces our Plnkr UI showing the live usages of the broken and fixed versions of the filter while updating the tax rate:</p>\n<p><img src="/assets/images/post/beware-hidden-inputs-in-angular-filters/output.png" alt="Plnkr UI"></p>\n<h3 id="takeaway">Takeaway</h3>\n<p>In Angular&#39;s defense, they are actually quite <a href="https://code.angularjs.org/1.4.14/docs/guide/filter#creating-custom-filters" title="Angular Custom Filters">explicit</a> about this in their documentation, but it&#39;s buried a bit down in the <code>$filter</code> documentation.  And, to be honest, I would venture to guess that most beginners learning how to implement filters are not reading the full Angular docs, but rather reading from a simplified blog post or Stack Overflow response that may not touch on the pure function requirement</p>\n<blockquote>\n<p> The filter function should be a <a href="https://en.wikipedia.org/wiki/Pure_function" title="Pure Function">pure function</a>, which means that it should be stateless and idempotent. Angular relies on these properties and executes the filter only when the inputs to the function change.</p>\n</blockquote>\n<p>That&#39;s it for today.  Hopefully this helps someone, somewhere, trying to track down a filter bug in their app.</p>\n',excerpt:"If you&apos;ve been writing JavaScript (or really any language for that matter) in the past few years, chances are you&apos;ve caught wind of the rising popularity of functional programming paradigms.  <em>Pure functions</em> are one of the major concepts of functional programming, and as it turns out, the usage of impure functions in Angular filters can produce some not-so-obvious bugs in your AngularJS application.",permalink:"/post/beware-hidden-inputs-in-angular-filters",readingTime:{text:"5 min read",minutes:4.725,time:283500,words:945},slug:"beware-hidden-inputs-in-angular-filters"},posts:[]},serverRendered:!0}}(void 0,"Matt Brophy")</script><script src="/_nuxt/runtime.94c5cfbdd2fb87a1541a.js" defer></script><script src="/_nuxt/async/pages/post/_slug.696eef9b23c1afe6e9f3.js" defer></script><script src="/_nuxt/async/commons.app.9c5135f89d753b8191ab.js" defer></script><script src="/_nuxt/async/app.000c4097745af34ba54f.js" defer></script>
  </body>
</html>
